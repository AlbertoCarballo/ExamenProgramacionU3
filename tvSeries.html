<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="./tvSeries.css">
</head>

<body>

  <div id="main">
    <div class="conendor-supremo">
      <div class="nav-bar">
        <nav class="navbar navbar-expand-lg" data-bs-theme="dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="#">Navbar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
              aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" @click="redirectHome">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#">Features</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#">Pricing</a>
                </li>
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    Dropdown link
                  </a>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">Action</a></li>
                    <li><a class="dropdown-item" href="#">Another action</a></li>
                    <li><a class="dropdown-item" href="#">Something else here</a></li>
                  </ul>
                </li>
              </ul>
              <div class="logout-button" style="margin-left: auto;">
                <button @click="logout">Log Out</button>
              </div>
            </div>
          </div>
        </nav>
      </div>
      <div class="card-info-container"
        :style="{ '--background-image': 'url(https://media.themoviedb.org/t/p/w440_and_h660_face/' + img + ')' }">
        <div class="card">
          <div class="first-content">
            <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + img"
              style="width:100% ; height:100%">
          </div>
          <div class="second-content">
            <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + img2"
              style="width:100% ; height:100%">
          </div>
        </div>

        <div class="info-container">
          <h1 v-model="titular"> {{titular}}</h1>
          <div class="genres-container">
            <h3>Generos:</h3>
            <div class="genres">
              <button  v-for="genre in genres" @click="redirectGenres(genre)">
                {{genre.name}}
              </button>
            </div>
          </div>
          <br>
          <div class="btn-adds">
            <button class="favorite" @click="addFavorite">
              <span> {{ favorite }} </span>
            </button>
            <div class="watch-trailer" @click="redirectTrailer">
              <button>
                Watch Trailer
              </button>
            </div>
            <br>
            <br>
          </div>
          <br>
          <div class="sinopsis">
            <span> Sinopsis <br> {{ sinopsis }}</span>
          </div>

          <div class="director" v-for="creator in creators">
            <span>{{ creator.name }}: <br> creador </span>
          </div>
        </div>
      </div>
      <div class="keywords-bar">
        <h2>Palabras Claves</h2>
        <div class="keyword">
          <button class="keyword-button" v-for="keyword in keywords" @click="redirectKeyword(keyword)"> 
            {{keyword.name}}
          </button>
        </div>
      </div>

      <div class="puntaje-container">
        <h2>Califica esta película (0 - 100): {{calificar}}</h2>
        <input type="range" v-model.number="calificar" id="rating" min="0" max="100" step="5" class="slider">
        <div class="puntaje-btn">
          <button class="calificar-btn" @click="calificarPeli">Calificar</button>
          <button class="borrar-btn" @click="borrarCalificacion">Borrar Calificación</button>
        </div>
      </div>

      <div class="reparto-container">
        <h2>Reparto de la serie</h2>
        <br>
        <div class="reparto">
          <div class="actor-card" v-for="casting in cast" @click="redirectActors(casting)">
            <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + casting.profile_path"
              style="width:100%; height:auto;">
            <h3>{{casting.name}}</h3>
            <p>{{casting.character}}</p>
            <p>{{casting.episode_count}} Episodios</p>
          </div>
        </div>
      </div>
      <br>
      <div class="recommendation">
        <h2>Recomendaciones</h2>
        <div class="card-recommendation-container">
          <div class="card-recommendation" v-for="recommendation in recommendation" :key="recommendation.id"
            @click="redirectTVSeries(recommendation)">
            <div class="image-container">
              <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + recommendation.poster_path"
                style="width:100%; height:auto;">
            </div>
            <div class="info-recommendation">
              <h3>{{ recommendation.name }}</h3>
              <div class="rating">
                <span>{{ recommendation.vote_average * 10 }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br>

      <div class="season-container">
        <div class="header">Última temporada</div>

        <div class="season-card" v-for="season in lastSeason">
          <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + season.poster_path"
            style="width: 300px; height:200px;">

          <div class="season-card-content">
            <h2>Temporada {{season.season_number}}</h2>
            <div class="info">
              <span class="rating">★ {{(season.vote_average)*10}}%</span>
              {{season.air_date}} • {{season.episode_count}} Episodios
            </div>
            <div class="description">
              Temporada {{season.season_number}} de {{titular}} se estrenó el {{season.air_date}}
            </div>
            <div class="episode-info">

              <span class="end-tag">Final de temporada</span>
            </div>
          </div>
        </div>
        <br>
        <button class="temporadas" @click="redirectSeasons">Ver Mas Temporadas</button>
      </div>
      <br>

    </div>


  </div>


  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const { createApp, ref } = Vue

    createApp({
      setup() {

        const name_app = ref('Mi primer app')
        const cast = ref([])
        const creators = ref([])
        const titular = ref("")
        const img = ref("")
        const img2 = ref("")
        const sinopsis = ref("")
        const calificar = ref(50);
        const genres = ref([])
        const favoriteFlag = ref(0);
        const favorite = ref("")
        const recommendation = ref([])
        const seasons = ref([])
        const lastSeason = ref([]);
        const keywords = ref([]);
        const serieTrailer = ref("");

        const ratings = ref(JSON.parse(localStorage.getItem('ratings')) || [])

        return {
          name_app,
          cast,
          creators,
          titular,
          img,
          img2,
          sinopsis,
          calificar,
          ratings,
          genres,
          favorite,
          recommendation,
          seasons,
          lastSeason,
          keywords,
          serieTrailer
        }

      },
      methods: {
        calificarPeli() {
          const urlParams = new URLSearchParams(window.location.search)
          const idPelicula = urlParams.get('id')
          const myHeaders = new Headers();
          myHeaders.append("Content-Type", "application/json");
          myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

          const raw = JSON.stringify({
            "value": (this.calificar / 10)
          });

          const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
          };

          const session = localStorage.getItem("session");
          fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/rating?session_id=${session}`, requestOptions)
            .then((response) => response.json())
            .then((result) => {
              if (result.success) {
              }
            })
            .catch((error) => console.error(error));
          if (this.calificar >= 80) {
            alert("oye que buena onda te traes")
          } else if (this.calificar >= 60 && this.calificar <= 79) {
            alert("oye te cargas una onda media")
          } else {
            alert("oye te cargas una mala onda ")
          }

        },
        borrarCalificacion() {

          const urlParams = new URLSearchParams(window.location.search);
          const idPelicula = urlParams.get('id');
          const session = localStorage.getItem("session");

          const myHeaders = new Headers();
          myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

          const requestOptions = {
            method: "DELETE",
            headers: myHeaders,
            redirect: "follow"
          };

          fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/rating?session_id=${session}`, requestOptions)
            .then((response) => response.json())
            .then((result) => {

            })
            .catch((error) => console.error(error));
          this.calificar = 0;

          alert("tu onda ha sido destruida.");
        },

        addFavorite() {
          const urlParams = new URLSearchParams(window.location.search);
          const idPelicula = urlParams.get('id');
          const session = localStorage.getItem("session");
          let username = localStorage.getItem("username");
          const myHeaders = new Headers();
          myHeaders.append("Content-Type", "application/json");
          myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");
          this.favoriteFlag = this.favoriteFlag === 1 ? 0 : 1;
          this.favorite = this.favoriteFlag === 1 ? "Remove from Favorite" : "Add to Favorite";



          const raw = JSON.stringify({
            "media_type": "tv",
            "media_id": idPelicula,
            "favorite": this.favoriteFlag === 1 ? true : false
          });

          const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
          };

          fetch(`https://api.themoviedb.org/3//account/${idPelicula}/favorite?session_id=${session}`, requestOptions)
            .then((response) => response.json())
            .then((result) => {

            })
            .catch((error) => console.error(error));


        },
        redirectTrailer() {
          window.open(`https://www.youtube.com/watch?v=${this.serieTrailer}`, '_blank');
        },
        redirectKeyword(keyword) {
          window.location.href = `pClave.html?id=${keyword.id}`;
        },
        redirectGenres(genre) {
          window.location.href = `categorias.html?id=${genre.id}`;
        },
        redirectTVSeries(recomendation) {
          console.log("hola")
          window.location.href = `tvSeries.html?id=${recomendation.id}`;

        },
        redirectActors(cast) {
          window.location.href = `artistDetail.html?id=${cast.id}`;
        },
        redirectSeasons(seasons) {
          const urlParams = new URLSearchParams(window.location.search)
          const idPelicula = urlParams.get('id')
          window.location.href = `seasons.html?id=${idPelicula}`;

        }


      },
      mounted() {
        const urlParams = new URLSearchParams(window.location.search)
        const idPelicula = urlParams.get('id')
        let is_log = localStorage.getItem("is_log");
        let username = localStorage.getItem("username");
        const session = localStorage.getItem("session");

        this.favorite = this.favoriteFlag === 0 ? "Remove from Favorite" : "Add to Favorite";
        if (is_log == null && username == null) {
          window.location.href = "index.html";
        }


        const myHeaders = new Headers();
        myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions = {
          method: "GET",
          headers: myHeaders,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//tv/${idPelicula}`, requestOptions)
          .then((response) => response.json())
          .then((result) => {
            this.genres = result.genres
            this.seasons = result.seasons
            this.creators = result.created_by
            this.titular = result.name;
            this.img = result.poster_path;
            this.img2 = result.backdrop_path;
            this.sinopsis = result.overview;
            if (this.seasons.length > 0) {
              this.lastSeason = [this.seasons[this.seasons.length - 1]];
            }
          })

        const myHeaders2 = new Headers();
        myHeaders2.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions2 = {
          method: "GET",
          headers: myHeaders2,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/aggregate_credits`, requestOptions2)
          .then((response) => response.json())
          .then((result) => {

            if (result.cast) {
              this.cast = result.cast.map(actor => {
                const characterName = actor.roles.length > 0 ? actor.roles[0].character : "";
                const characterEpisode = actor.roles.length > 0 ? actor.roles[0].episode_count : "";
                console.log(characterEpisode)
                return {
                  id: actor.id,
                  name: actor.name,
                  profile_path: actor.profile_path,
                  character: characterName,
                  episode_count: characterEpisode
                };
              });
            }

          })
          .catch((error) => console.error(error));
        const myHeaders3 = new Headers();
        myHeaders3.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions3 = {
          method: "GET",
          headers: myHeaders3,
          redirect: "follow"
        };


        fetch(`https://api.themoviedb.org/3/account/${username}/rated/tv?session_id=${session}`, requestOptions3)
          .then((response) => response.json())
          .then((result) => {
            const movie = result.results.find(movie => movie.id == idPelicula);
            if (movie) {
              this.calificar = movie.rating * 10;
            } else {
              this.calificar = 0;
            }

          })
          .catch((error) => console.error(error));

        const myHeaders4 = new Headers();
        myHeaders4.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions4 = {
          method: "GET",
          headers: myHeaders4,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//account/${username}/favorite/tv?session_id=${session}`, requestOptions4)
          .then((response) => response.json())
          .then((result) => {
            const serie = result.results.find(serie => serie.id == idPelicula);
            if (serie) {
              this.favoriteFlag = 1
              this.favorite = "Remove from Favorite"
            } else {
              this.favoriteFlag = 0
              this.favorite = "Add to Favorite"
            }
          })
          .catch((error) => console.error(error));

        const myHeaders5 = new Headers();
        myHeaders5.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions5 = {
          method: "GET",
          headers: myHeaders5,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/recommendations`, requestOptions5)
          .then((response) => response.json())
          .then((result) => {
            this.recommendation = result.results
          })
          .catch((error) => console.error(error));

        const myHeaders6 = new Headers();
        myHeaders6.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions6 = {
          method: "GET",
          headers: myHeaders6,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/keywords`, requestOptions6)
          .then((response) => response.json())
          .then((result) => {
            this.keywords = result.results
          })
          .catch((error) => console.error(error));


        const myHeaders7 = new Headers();
        myHeaders7.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions7 = {
          method: "GET",
          headers: myHeaders7,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/videos?language=en-US`, requestOptions7)
          .then((response) => response.json())
          .then((result) => {

            for (let index = 0; index < result.results.length; index++) {
              this.serieTrailer = result.results[index].key

            }
          })
          .catch((error) => console.error(error));
      }
    }).mount('#main') 
  </script>
</body>

</html>