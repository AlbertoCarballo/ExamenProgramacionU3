<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./tvSeries.css">
</head>

<body>

  <div id="main">
    <div class="card-info-container">
      <div class="card">
        <div class="first-content">
          <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + img"
            style="width:100% ; height:100%">
        </div>
        <div class="second-content">
          <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + img2"
            style="width:100% ; height:100%">
        </div>
      </div>

      <div class="info-container">
        <h1 v-model="titular"> {{titular}}</h1>
        <div class="genres" v-for="genre in genres">
          <span>{{genre.name}}</span>
        </div>
        <button class="favorite" @click="addFavorite">
          <span> {{ favorite }} </span>
        </button>

        <div class="sinopsis">
          <span> Sinopsis <br> {{ sinopsis }}</span>
        </div>

        <div class="director" v-for="creator in creators">
          <span>{{ creator.name }}: <br> creador </span>
        </div>
      </div>
    </div>

    <div class="puntaje-container">
      <label>Califica esta película (0 - 100): {{calificar}}</label>
      <input type="range" v-model.number="calificar" id="rating" min="0" max="100" step="5" class="slider">
      <div class="puntaje-btn">
        <button class="calificar-btn" @click="calificarPeli">Calificar</button>
        <button class="borrar-btn" @click="borrarCalificacion">Borrar Calificación</button>
      </div>
    </div>
    <div class="reparto-container">
      <h2>Reparto de la serie</h2>
      <br>
      <div class="reparto">
        <div class="actor-card" v-for="casting in cast">
          <img v-bind:src="'https://media.themoviedb.org/t/p/w440_and_h660_face/' + casting.profile_path"
            style="width:100%; height:auto;">
          <h3>{{casting.name}}</h3>
          <p>{{casting.character}}</p>
          <p>{{casting.total_episode_count}} Episodios</p>
        </div>
      </div>
    </div>
  </div>


  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const { createApp, ref } = Vue

    createApp({
      setup() {

        const name_app = ref('Mi primer app')
        const cast = ref([])
        const creators = ref([])
        const titular = ref("")
        const img = ref("")
        const img2 = ref("")
        const sinopsis = ref("")
        const calificar = ref(50);
        const genres = ref([])
        const favoriteFlag = ref(0);
        const favorite = ref("")

        const ratings = ref(JSON.parse(localStorage.getItem('ratings')) || [])

        return {
          name_app,
          cast,
          creators,
          titular,
          img,
          img2,
          sinopsis,
          calificar,
          ratings,
          genres,
          favorite
        }

      },
      methods: {
        calificarPeli() {


          const urlParams = new URLSearchParams(window.location.search)
          const idPelicula = urlParams.get('id')
          const myHeaders = new Headers();
          myHeaders.append("Content-Type", "application/json");
          myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

          const raw = JSON.stringify({
            "value": (this.calificar / 10)
          });

          const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
          };

          const session = localStorage.getItem("session");
          fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/rating?session_id=${session}`, requestOptions)
            .then((response) => response.json())
            .then((result) => {
              console.log(result.success)
              if (result.success) {
                console.log("entre")
              }
            })
            .catch((error) => console.error(error));
          if (this.calificar >= 80) {
            alert("oye que buena onda te traes")
          } else if (this.calificar >= 60 && this.calificar <= 79) {
            alert("oye te cargas una onda media")
          } else {
            alert("oye te cargas una mala onda ")
          }

        },
        borrarCalificacion() {

          const urlParams = new URLSearchParams(window.location.search);
          const idPelicula = urlParams.get('id');
          const session = localStorage.getItem("session");

          const myHeaders = new Headers();
          myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

          const requestOptions = {
            method: "DELETE",
            headers: myHeaders,
            redirect: "follow"
          };

          fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/rating?session_id=${session}`, requestOptions)
            .then((response) => response.json())
            .then((result) => console.log(result))
            .catch((error) => console.error(error));
          this.calificar = 0;

          alert("tu onda ha sido destruida.");
        },

        addFavorite() {
          const urlParams = new URLSearchParams(window.location.search);
          const idPelicula = urlParams.get('id');
          const session = localStorage.getItem("session");
          let username = localStorage.getItem("username");


          const myHeaders = new Headers();
          myHeaders.append("Content-Type", "application/json");
          myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");
          this.favoriteFlag = this.favoriteFlag === 1 ? 0 : 1;
          this.favorite = this.favoriteFlag === 1 ? "Remove from Favorite" : "Add to Favorite";



          const raw = JSON.stringify({
            "media_type": "tv",
            "media_id": idPelicula,
            "favorite": this.favoriteFlag === 1 ? true : false
          });

          const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
          };

          fetch(`https://api.themoviedb.org/3//account/${idPelicula}/favorite?session_id=${session}`, requestOptions)
            .then((response) => response.json())
            .then((result) => { console.log(result) })
            .catch((error) => console.error(error));

          
        }


      },
      mounted() {
        const urlParams = new URLSearchParams(window.location.search)
        const idPelicula = urlParams.get('id')
        let is_log = localStorage.getItem("is_log");
        let username = localStorage.getItem("username");
        const session = localStorage.getItem("session");

        this.favorite = this.favoriteFlag === 0 ? "Remove from Favorite" : "Add to Favorite";
        if (is_log == null && username == null) {
          window.location.href = "index.html";
        }


        const myHeaders = new Headers();
        myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions = {
          method: "GET",
          headers: myHeaders,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//tv/${idPelicula}`, requestOptions)
          .then((response) => response.json())
          .then((result) => {
            console.log("hola")


            this.genres = result.genres
            this.creators = result.created_by
            console.log(this.genres)
            this.titular = result.name;
            this.img = result.poster_path;
            this.img2 = result.backdrop_path;
            this.sinopsis = result.overview;
          })

        const myHeaders2 = new Headers();
        myHeaders2.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions2 = {
          method: "GET",
          headers: myHeaders2,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//tv/${idPelicula}/aggregate_credits`, requestOptions2)
          .then((response) => response.json())
          .then((result) => {

            if (result.cast) {
              this.cast = result.cast.map(actor => {
                const characterName = actor.roles.length > 0 ? actor.roles[0].character : "";
                return {
                  id: actor.id,
                  name: actor.name,
                  profile_path: actor.profile_path,
                  character: characterName
                };
              });
            }

            console.log("Cast después de mapear:", this.cast);
            console.log(this.cast);
          })
          .catch((error) => console.error(error));
        const myHeaders3 = new Headers();
        myHeaders3.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions3 = {
          method: "GET",
          headers: myHeaders3,
          redirect: "follow"
        };


        fetch(`https://api.themoviedb.org/3/account/${username}/rated/tv?session_id=${session}`, requestOptions3)
          .then((response) => response.json())
          .then((result) => {
            // console.log(result);
            console.log("serie")
            const movie = result.results.find(movie => movie.id == idPelicula);
            console.log(movie)
            if (movie) {
              this.calificar = movie.rating * 10;
            } else {
              this.calificar = 0;
            }

          })
          .catch((error) => console.error(error));

        const myHeaders4 = new Headers();
        myHeaders4.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIwNmYxN2MyZGEyMDQ5Njg0ZTRjYmJmOTE1YmI3ZmE5MSIsIm5iZiI6MTcyODQyMDc0Ny45MjIzMDUsInN1YiI6IjY3MDU5OTM4ZjRiOTE5ZjgzOTc3OGJmNCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.P2ljJ6l49mdKja0Fj5G-9mQ0CJcJKah8c_KjT_U2OVw");

        const requestOptions4 = {
          method: "GET",
          headers: myHeaders4,
          redirect: "follow"
        };

        fetch(`https://api.themoviedb.org/3//account/${username}/favorite/tv?session_id=${session}`, requestOptions4)
          .then((response) => response.json())
          .then((result) => {
            const serie = result.results.find(serie => serie.id == idPelicula);
            if (serie) {
              this.favoriteFlag=1
              this.favorite="Remove from Favorite"
            } else {
              this.favoriteFlag=0
              this.favorite="Add to Favorite"
            }
            // const movie = result.results.find(movie => movie.id == idPelicula);
          })
          .catch((error) => console.error(error));



      }
    }).mount('#main') 
  </script>
</body>

</html>